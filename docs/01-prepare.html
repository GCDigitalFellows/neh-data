<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Prepare data</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/paper.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #f8f8f8; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
pre, code { background-color: #f8f8f8; }
code > span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code > span.dt { color: #204a87; } /* DataType */
code > span.dv { color: #0000cf; } /* DecVal */
code > span.bn { color: #0000cf; } /* BaseN */
code > span.fl { color: #0000cf; } /* Float */
code > span.ch { color: #4e9a06; } /* Char */
code > span.st { color: #4e9a06; } /* String */
code > span.co { color: #8f5902; font-style: italic; } /* Comment */
code > span.ot { color: #8f5902; } /* Other */
code > span.al { color: #ef2929; } /* Alert */
code > span.fu { color: #000000; } /* Function */
code > span.er { color: #a40000; font-weight: bold; } /* Error */
code > span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #000000; } /* Constant */
code > span.sc { color: #000000; } /* SpecialChar */
code > span.vs { color: #4e9a06; } /* VerbatimString */
code > span.ss { color: #4e9a06; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #000000; } /* Variable */
code > span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code > span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code > span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code > span.ex { } /* Extension */
code > span.at { color: #c4a000; } /* Attribute */
code > span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code > span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="workshop.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 64px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 69px;
  margin-top: -69px;
}

.section h2 {
  padding-top: 69px;
  margin-top: -69px;
}
.section h3 {
  padding-top: 69px;
  margin-top: -69px;
}
.section h4 {
  padding-top: 69px;
  margin-top: -69px;
}
.section h5 {
  padding-top: 69px;
  margin-top: -69px;
}
.section h6 {
  padding-top: 69px;
  margin-top: -69px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->





<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
        <!-- NOTE: add "navbar-inverse" class for an alternate navbar background -->
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      <a class="navbar-brand" href="#">
        <img alt="GC Digital Initiatives" src="images/gcdi-logo.svg" style="height: 100%; padding: 5px; width: auto;">
      </a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li><a href="01-prepare.html">Preparing data</a></li>
        <li><a href="02-exploring.html">Exploring data</a></li>        
        <li><a href="03-inequality.html">Funding inequality</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="https://github.com/GCDigitalFellows/visualizing-neh"><i class="fa fa-2x fa-github" aria-hidden="true"></i></a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Prepare data</h1>

</div>


<div id="downloading-source-files" class="section level3">
<h3>Downloading source files</h3>
<p>Fortunately, the NEH provides open access to their <a href="https://securegrants.neh.gov/open/data/">grants data</a>. We first use <code>rvest::read_html</code> to get a list of all the zipped grant files:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">listnehgrantzips &lt;-<span class="st"> </span>function() {
  zipurls &lt;-<span class="st"> </span><span class="kw">read_html</span>(<span class="st">&#39;https://securegrants.neh.gov/open/data&#39;</span>) %&gt;%
<span class="st">    </span><span class="kw">html_nodes</span>(<span class="st">&#39;a[href*=&quot;NEH_Grants&quot;][href$=&quot;.zip&quot;]&#39;</span>) %&gt;%
<span class="st">    </span><span class="kw">html_attr</span>(<span class="st">&#39;href&#39;</span>) %&gt;%
<span class="st">    </span><span class="kw">paste0</span>(<span class="st">&#39;https://securegrants.neh.gov/&#39;</span>, .)
}</code></pre></div>
<p>Each grant zip file contains an XML data file and an XML Schema Definition file, which we can ignore for our current purposes. We save the XML to a directory in our project directory:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">downloadxml &lt;-<span class="st"> </span>function(url) {
  DATADIR &lt;-<span class="st"> &#39;./.data&#39;</span>
  <span class="co"># intermediate files will be saved between steps</span>
  <span class="kw">dir.create</span>(DATADIR, <span class="dt">showWarnings =</span> <span class="ot">FALSE</span>)
  xmlfile &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;.zip&quot;</span>, <span class="st">&quot;.xml&quot;</span>, <span class="kw">basename</span>(url))
  <span class="co"># only download if xml file doesn&#39;t already exist</span>
  if(!<span class="kw">file.exists</span>(<span class="kw">file.path</span>(DATADIR, xmlfile))) {
    tf &lt;-<span class="st"> </span><span class="kw">tempfile</span>()
    <span class="kw">download.file</span>(url, tf, <span class="dt">quiet =</span> <span class="ot">TRUE</span>)
    <span class="kw">unzip</span>(tf, xmlfile, <span class="dt">exdir=</span>DATADIR)
  } else {
    <span class="kw">file.path</span>(DATADIR, xmlfile)
  }
}</code></pre></div>
<p>Finally, we pull these two functions together using <code>purrr::map</code> to download each file:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">xmlfiles &lt;-<span class="st"> </span><span class="kw">listnehgrantzips</span>() %&gt;%<span class="st"> </span><span class="kw">map</span>(~<span class="st"> </span><span class="kw">downloadxml</span>(.)) %&gt;%<span class="st"> </span>unlist</code></pre></div>
</div>
<div id="extracting-data-from-source-files" class="section level3">
<h3>Extracting data from source files</h3>
<p>The XML format can be difficult to load into a data table for analysis. It requires us to transform its nested structure into a unnested table form, with rows and columns. We use the <code>xml2::read_xml</code> function to pull nodes out of the XML tree structure:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">read_xml</span>(<span class="kw">tail</span>(xmlfiles, <span class="dv">1</span>)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">xml_find_all</span>(<span class="st">&#39;./Grant&#39;</span>) %&gt;%
<span class="st">  </span><span class="kw">head</span>(<span class="dv">1</span>) %&gt;%
<span class="st">  </span><span class="kw">xml_children</span>()</code></pre></div>
<pre><code>## {xml_nodeset (27)}
##  [1] &lt;ApplicantType&gt;O&lt;/ApplicantType&gt;
##  [2] &lt;Institution&gt;Center for Independent Documentary, Inc.&lt;/Institution&gt;
##  [3] &lt;OrganizationType&gt;Four-Year College&lt;/OrganizationType&gt;
##  [4] &lt;InstCity&gt;Boston&lt;/InstCity&gt;
##  [5] &lt;InstState&gt;MA&lt;/InstState&gt;
##  [6] &lt;InstPostalCode&gt;02135-1032&lt;/InstPostalCode&gt;
##  [7] &lt;InstCountry&gt;USA&lt;/InstCountry&gt;
##  [8] &lt;CouncilDate&gt;2009-07-01&lt;/CouncilDate&gt;
##  [9] &lt;YearAwarded&gt;2010&lt;/YearAwarded&gt;
## [10] &lt;ProjectTitle&gt;Mysticism and Monotheism&lt;/ProjectTitle&gt;
## [11] &lt;Program&gt;America&#39;s Media Makers: Development Grants&lt;/Program&gt;
## [12] &lt;Division&gt;Public Programs&lt;/Division&gt;
## [13] &lt;ApprovedOutright&gt;65000.0000&lt;/ApprovedOutright&gt;
## [14] &lt;ApprovedMatching&gt;0.0000&lt;/ApprovedMatching&gt;
## [15] &lt;AwardOutright&gt;65000.0000&lt;/AwardOutright&gt;
## [16] &lt;AwardMatching&gt;0.0000&lt;/AwardMatching&gt;
## [17] &lt;OriginalAmount&gt;65000.0000&lt;/OriginalAmount&gt;
## [18] &lt;BeginGrant&gt;2010-02-01T00:00:00&lt;/BeginGrant&gt;
## [19] &lt;EndGrant&gt;2010-08-31T00:00:00&lt;/EndGrant&gt;
## [20] &lt;ProjectDesc/&gt;
## ...</code></pre>
<p>We need to pull out the <code>AppNumber</code> attribute since this is the unique number used by the NEH to identify awarded grants.</p>
<p>Of the 28 fields that are in the nodeset for each Grant, <code>Participant</code> and <code>Discipline</code> are nested nodes. The <code>Discipline</code> node is simply a list of <code>Name</code> nodes.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">read_xml</span>(<span class="st">&#39;.data/NEH_Grants2000s.xml&#39;</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">xml_find_all</span>(<span class="st">&#39;./Grant/*[count(*) &gt; 0]&#39;</span>) %&gt;%
<span class="st">  </span><span class="kw">head</span>(<span class="dv">5</span>)</code></pre></div>
<pre><code>## {xml_nodeset (5)}
## [1] &lt;Participant&gt;\n  &lt;Firstname&gt;Ruby&lt;/Firstname&gt;\n  &lt;Lastname&gt;Buck&lt;/Last ...
## [2] &lt;Participant&gt;\n  &lt;Firstname&gt;Catherine&lt;/Firstname&gt;\n  &lt;Lastname&gt;Court ...
## [3] &lt;Discipline&gt;\n  &lt;Name&gt;Music History and Criticism&lt;/Name&gt;\n&lt;/Discipline&gt;
## [4] &lt;Participant&gt;\n  &lt;Firstname&gt;Robert&lt;/Firstname&gt;\n  &lt;Lastname&gt;Wilson&lt;/ ...
## [5] &lt;Participant&gt;\n  &lt;Firstname&gt;Craig&lt;/Firstname&gt;\n  &lt;Lastname&gt;Pascoe&lt;/L ...</code></pre>
<p>Following <a href="https://github.com/jennybc/manipulate-xml-with-purrr-dplyr-tidyr#readme">How to tame XML with nested data frames and purrr</a>, we create the following function to transform our XML data to a data frame:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">xmltodf &lt;-<span class="st"> </span>function(xmlfile) {
  grants &lt;-<span class="st"> </span><span class="kw">read_xml</span>(xmlfile) %&gt;%<span class="st"> </span><span class="kw">xml_find_all</span>(<span class="st">&#39;./Grant&#39;</span>)
  df &lt;-<span class="st"> </span><span class="kw">data_frame</span>(<span class="dt">row =</span> <span class="kw">seq_along</span>(grants),
                   <span class="dt">nodeset =</span> grants) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">col_name_raw =</span> nodeset %&gt;%<span class="st"> </span><span class="kw">map</span>(~<span class="st"> </span><span class="kw">xml_children</span>(.)) %&gt;%<span class="st"> </span><span class="kw">map</span>(~<span class="st"> </span><span class="kw">xml_name</span>(.)),
           <span class="dt">cell_text =</span> nodeset %&gt;%<span class="st"> </span><span class="kw">map</span>(~<span class="st"> </span><span class="kw">xml_children</span>(.)) %&gt;%<span class="st"> </span><span class="kw">map</span>(~<span class="st"> </span><span class="kw">xml_text</span>(.)),
           <span class="dt">appnumber =</span> nodeset %&gt;%<span class="st"> </span><span class="kw">xml_attr</span>(<span class="st">&#39;AppNumber&#39;</span>),
           <span class="dt">i =</span> nodeset %&gt;%<span class="st"> </span><span class="kw">map</span>(~<span class="st"> </span><span class="kw">xml_children</span>(.)) %&gt;%<span class="st"> </span><span class="kw">map</span>(~<span class="st"> </span><span class="kw">seq_along</span>(.))) %&gt;%
<span class="st">    </span><span class="kw">select</span>(row, i, appnumber, col_name_raw, cell_text) %&gt;%
<span class="st">    </span><span class="kw">unnest</span>() %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(row, appnumber, col_name_raw) %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">cell_text =</span> <span class="kw">toString</span>(cell_text)) %&gt;%
<span class="st">    </span><span class="kw">ungroup</span>() %&gt;%
<span class="st">    </span><span class="kw">spread</span>(col_name_raw, cell_text)
  df
}</code></pre></div>
<p>We use the <code>xmltodf</code> function to through all the XML files we have downloaded and transform them into data frames that we finally combine into one. We save the data to the file system to avoid redoing this process each time we run these scripts.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">if(!<span class="kw">file.exists</span>(<span class="st">&#39;.RData&#39;</span>)) {
  nehgrants &lt;-<span class="st"> </span>xmlfiles %&gt;%<span class="st"> </span>
<span class="st">      </span><span class="kw">map</span>(~<span class="st"> </span><span class="kw">xmltodf</span>(.)) %&gt;%
<span class="st">      </span><span class="kw">bind_rows</span>()
  <span class="kw">save.image</span>()
} else {
  <span class="kw">load</span>(<span class="st">&#39;.RData&#39;</span>)
}</code></pre></div>
</div>
<div id="cleaning" class="section level3">
<h3>Cleaning</h3>
<p>The full NEH grant dataset contains 63228 distinct <code>AppNumber</code> values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nehgrants %&gt;%
<span class="st">  </span><span class="kw">select</span>(appnumber) %&gt;%
<span class="st">  </span>distinct %&gt;%
<span class="st">  </span>count</code></pre></div>
<pre><code>## # A tibble: 1 × 1
##       n
##   &lt;int&gt;
## 1 63228</code></pre>
<p>We would expect the <code>AppNumber</code> to be unique, but 310 of those 63228 (0.4%) have duplicate entries.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nehgrants %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(appnumber) %&gt;%
<span class="st">  </span>count %&gt;%
<span class="st">  </span><span class="kw">filter</span>(n &gt;<span class="st"> </span><span class="dv">1</span>) %&gt;%
<span class="st">  </span>count</code></pre></div>
<pre><code>## # A tibble: 1 × 1
##      nn
##   &lt;int&gt;
## 1   310</code></pre>
<p>The problem seems to lie in inconsistent values in the <code>ToSupport</code> column:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nehgrants %&gt;%
<span class="st">  </span><span class="kw">select</span>(-row) %&gt;%
<span class="st">  </span><span class="kw">gather</span>(column, value, -appnumber) %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(appnumber, column) %&gt;%
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">n=</span><span class="kw">n_distinct</span>(value)) %&gt;%
<span class="st">  </span><span class="kw">filter</span>(n&gt;<span class="dv">1</span>) %&gt;%
<span class="st">  </span><span class="kw">ungroup</span>() %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(column) %&gt;%
<span class="st">  </span>count</code></pre></div>
<pre><code>## # A tibble: 1 × 2
##      column    nn
##       &lt;chr&gt; &lt;int&gt;
## 1 ToSupport    47</code></pre>
<p>Therefore, to “clean” our data we will for the time being remove the column(s) creating unnnecessary duplicates and convert column types appropriately:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">grants &lt;-<span class="st"> </span>nehgrants %&gt;%
<span class="st">  </span><span class="kw">select</span>(-row, -ToSupport) %&gt;%
<span class="st">  </span><span class="kw">mutate_if</span>(is.character, <span class="kw">funs</span>(type.convert)) %&gt;%
<span class="st">  </span><span class="kw">distinct</span>()</code></pre></div>
<p>So, now the duplicate row issue is resolved:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">grants %&gt;%
<span class="st">  </span><span class="kw">group_by</span>(appnumber) %&gt;%
<span class="st">  </span>count %&gt;%
<span class="st">  </span><span class="kw">filter</span>(n &gt;<span class="st"> </span><span class="dv">1</span>)</code></pre></div>
<pre><code>## # A tibble: 0 × 2
## # ... with 2 variables: appnumber &lt;fctr&gt;, n &lt;int&gt;</code></pre>
</div>
<div id="funding-adjusted-for-inflation" class="section level3">
<h3>Funding adjusted for inflation</h3>
<p>In defining NEH funding, the <a href="https://securegrants.neh.gov/Open/data/NEH_GrantsDictionary.pdf">NEH Grants Data Dictionary</a> explains that there are five different dollar amounts included in the grants dataset:</p>
<ol style="list-style-type: decimal">
<li>ApprovedOutright: Approved amount (outright funds). (Outright funds are not contingent on additional fundraising.)</li>
<li>ApprovedMatching: Approved amount (matching funds). (Federal matching funds require a grantee to secure gift funds from third parties before federal funds are awarded. Except for Challenge Grants, NEH matching awards are made on a one-to-one basis.)</li>
<li>AwardOutright: Amount actually awarded (outright funds).</li>
<li>AwardMatching: Amount actually awarded (matching funds).</li>
<li>OriginalAmount: Original amount of grant (minus any grant supplements).</li>
</ol>
<p>We will define the relevant <code>funding</code> value as the sum of <code>ApprovedOutright</code> and <code>ApprovedMatching</code>.</p>
<p>Furthermore, we will adjust funding dollars into 2016 dollars using the <code>blscrapeR::inflation_adjust</code> function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cpiadj &lt;-<span class="st"> </span><span class="kw">inflation_adjust</span>(<span class="dv">2017</span>) %&gt;%
<span class="st">  </span><span class="kw">data_frame</span>(<span class="dt">YearAwarded =</span> <span class="kw">seq_along</span>(.) +<span class="st"> </span><span class="dv">1946</span>, 
             <span class="dt">Adj =</span> .)</code></pre></div>
</div>
<div id="participants" class="section level3">
<h3>Participants</h3>
<p>Though the bulk of projects have only one participant, there are a number more that have more than that.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nehgrants %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(ParticipantCount) %&gt;%<span class="st"> </span>
<span class="st">  </span>count</code></pre></div>
<pre><code>## # A tibble: 10 × 2
##    ParticipantCount     n
##               &lt;chr&gt; &lt;int&gt;
## 1                 0  3067
## 2                 1 58662
## 3                 2  1547
## 4                 3   300
## 5                 4   114
## 6                 5    54
## 7                 6    15
## 8                 7     3
## 9                 8     6
## 10                9     2</code></pre>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
